version: 1.0
runtime: python3
build:
  commands:
    pre-build:
      - echo "Pre-build phase"
      - pip install --upgrade pip
    build:
      - echo "Build phase"
      - pip install -r requirements.txt
    post-build:
      - echo "Post-build phase"
      - mkdir -p /app/uploads
      - mkdir -p /app/templates_storage
      - mkdir -p /app/learned_preferences_storage
run:
  runtime-version: 3.9.16
  command: gunicorn --bind 0.0.0.0:$PORT --workers 2 --threads 4 --timeout 60 app:app
  network:
    port: 8080
    env: PORT
  health-check:
    path: '/health'
    port: '8081'
    interval: 30
    timeout: 5
    healthy-threshold: 1
    unhealthy-threshold: 3
  env:
    - name: FLASK_ENV
      value: "production"
    - name: PORT
      value: "8080"
    - name: HEALTH_PORT
      value: "8081"
    - name: PYTHONUNBUFFERED
      value: "1"
  secrets:
    - name: AZURE_OPENAI_KEY
      value-from: "/vendor-statements/azure-openai-key"
    - name: AZURE_OPENAI_ENDPOINT
      value-from: "/vendor-statements/azure-openai-endpoint"
